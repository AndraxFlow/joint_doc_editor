<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - DocCollab</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .editor {
            width: 100%;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        .logs {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ WebSocket Test - DocCollab</h1>
        
        <div id="status" class="status disconnected">‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
        
        <div>
            <button id="connectBtn" class="btn">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket</button>
            <button id="disconnectBtn" class="btn" disabled>üîå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="clearBtn" class="btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
        
        <div style="margin: 20px 0;">
            <label for="documentId"><strong>ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong></label>
            <input type="text" id="documentId" value="cb73c6d3-8aed-4a1f-b06d-5b507aed15dc" style="width: 400px; margin-left: 10px; padding: 5px;">
        </div>
        
        <div style="margin: 20px 0;">
            <label for="userId"><strong>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong></label>
            <input type="text" id="userId" value="c1de4629-e46b-4baf-b401-da37097508f7" style="width: 400px; margin-left: 10px; padding: 5px;">
        </div>
        
        <div style="margin: 20px 0;">
            <label for="editor"><strong>–†–µ–¥–∞–∫—Ç–æ—Ä:</strong></label><br>
            <textarea id="editor" class="editor" placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –∑–¥–µ—Å—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
        </div>
        
        <div>
            <strong>üìã –õ–æ–≥–∏ WebSocket:</strong>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script>
        class WebSocketTest {
            constructor() {
                this.websocket = null;
                this.isConnected = false;
                this.isApplyingRemoteOperation = false;
                this.localVersion = 0;
                this.syncInterval = null;
                
                this.setupElements();
                this.setupEventListeners();
            }
            
            setupElements() {
                this.statusEl = document.getElementById('status');
                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.documentIdEl = document.getElementById('documentId');
                this.userIdEl = document.getElementById('userId');
                this.editorEl = document.getElementById('editor');
                this.logsEl = document.getElementById('logs');
            }
            
            setupEventListeners() {
                this.connectBtn.addEventListener('click', () => this.connect());
                this.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.clearBtn.addEventListener('click', () => this.clearLogs());
                
                this.editorEl.addEventListener('input', () => {
                    if (!this.isApplyingRemoteOperation) {
                        this.handleLocalChange();
                    }
                });
            }
            
            connect() {
                const documentId = this.documentIdEl.value.trim();
                const userId = this.userIdEl.value.trim();
                
                if (!documentId || !userId) {
                    this.log('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                    return;
                }
                
                if (this.websocket) {
                    this.websocket.close();
                }
                
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsHost = window.location.host;
                const wsUrl = `${wsProtocol}//${wsHost}/collaboration/documents/${documentId}/ws/${userId}`;
                
                this.log(`üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket: ${wsUrl}`, 'info');
                
                try {
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        this.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                        this.updateConnectionStatus(true);
                        this.isConnected = true;
                        this.startPeriodicSync();
                    };
                    
                    this.websocket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(message)}`, 'info');
                        this.handleMessage(message);
                    };
                    
                    this.websocket.onclose = (event) => {
                        this.log(`‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω: ${event.code} - ${event.reason}`, 'error');
                        this.updateConnectionStatus(false);
                        this.isConnected = false;
                        this.stopPeriodicSync();
                    };
                    
                    this.websocket.onerror = (error) => {
                        this.log(`üö´ –û—à–∏–±–∫–∞ WebSocket: ${error}`, 'error');
                        this.updateConnectionStatus(false);
                    };
                    
                } catch (error) {
                    this.log(`üí• –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                }
            }
            
            disconnect() {
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
                this.updateConnectionStatus(false);
                this.isConnected = false;
            }
            
            handleMessage(message) {
                switch (message.type) {
                    case 'connected':
                        this.log(`üéâ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É: ${message.data.document_id}`, 'success');
                        this.log(`üë• –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${message.data.active_users.join(', ')}`, 'info');
                        break;
                    case 'operation':
                        this.handleRemoteOperation(message.data);
                        break;
                    case 'sync_response':
                        this.handleSyncResponse(message.data);
                        break;
                    case 'user_joined':
                        this.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ${message.data.user_id}`, 'info');
                        break;
                    case 'user_left':
                        this.log(`üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª: ${message.data.user_id}`, 'info');
                        break;
                    case 'error':
                        this.log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${message.data.message}`, 'error');
                        break;
                    default:
                        this.log(`‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${message.type}`, 'info');
                }
            }
            
            handleLocalChange() {
                if (!this.isConnected || !this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                    return;
                }
                
                // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞–∫ –æ–ø–µ—Ä–∞—Ü–∏—é –∑–∞–º–µ–Ω—ã
                const content = this.editorEl.value;
                const operation = {
                    type: 'operation',
                    data: {
                        type: 'replace',
                        content: content,
                        version: this.localVersion++
                    }
                };
                
                this.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏: ${JSON.stringify(operation)}`, 'info');
                this.websocket.send(JSON.stringify(operation));
            }
            
            handleRemoteOperation(operation) {
                this.isApplyingRemoteOperation = true;
                
                try {
                    if (operation.type === 'replace') {
                        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
                        const newContent = operation.content || '';
                        this.editorEl.value = newContent;
                        this.log(`‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–º–µ–Ω—ã: "${newContent}"`, 'success');
                    } else if (operation.type === 'insert') {
                        const currentContent = this.editorEl.value;
                        const pos = operation.position || 0;
                        const text = operation.content || '';
                        const newContent = currentContent.slice(0, pos) + text + currentContent.slice(pos);
                        this.editorEl.value = newContent;
                        this.log(`‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –≤—Å—Ç–∞–≤–∫–∏: –ø–æ–∑–∏—Ü–∏—è ${pos}, —Ç–µ–∫—Å—Ç "${text}"`, 'success');
                    } else if (operation.type === 'delete') {
                        const currentContent = this.editorEl.value;
                        const pos = operation.position || 0;
                        const length = operation.length || 0;
                        const newContent = currentContent.slice(0, pos) + currentContent.slice(pos + length);
                        this.editorEl.value = newContent;
                        this.log(`‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è: –ø–æ–∑–∏—Ü–∏—è ${pos}, –¥–ª–∏–Ω–∞ ${length}`, 'success');
                    }
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                } finally {
                    setTimeout(() => {
                        this.isApplyingRemoteOperation = false;
                    }, 100);
                }
            }
            
            startPeriodicSync() {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                this.syncInterval = setInterval(() => {
                    if (this.isConnected && this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        this.requestSync();
                    }
                }, 2000);
                this.log('üîÑ –ó–∞–ø—É—â–µ–Ω–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', 'info');
            }
            
            stopPeriodicSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                    this.log('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', 'info');
                }
            }
            
            requestSync() {
                const syncMessage = {
                    type: 'sync_request'
                };
                this.websocket.send(JSON.stringify(syncMessage));
                this.log('üì§ –ó–∞–ø—Ä–æ—à–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', 'info');
            }
            
            handleSyncResponse(data) {
                this.isApplyingRemoteOperation = true;
                try {
                    const serverContent = data.content || '';
                    const serverVersion = data.version || 0;
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–æ–≤–µ–µ
                    if (serverVersion > this.localVersion) {
                        this.editorEl.value = serverContent;
                        this.localVersion = serverVersion;
                        this.log(`üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: –≤–µ—Ä—Å–∏—è ${serverVersion}`, 'success');
                    }
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                } finally {
                    setTimeout(() => {
                        this.isApplyingRemoteOperation = false;
                    }, 100);
                }
            }
            
            updateConnectionStatus(connected) {
                if (connected) {
                    this.statusEl.className = 'status connected';
                    this.statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    this.connectBtn.disabled = true;
                    this.disconnectBtn.disabled = false;
                } else {
                    this.statusEl.className = 'status disconnected';
                    this.statusEl.textContent = '‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    this.connectBtn.disabled = false;
                    this.disconnectBtn.disabled = true;
                }
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '5px';
                
                let color = '#000';
                switch (type) {
                    case 'success': color = '#28a745'; break;
                    case 'error': color = '#dc3545'; break;
                    case 'info': color = '#007bff'; break;
                }
                
                logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
                this.logsEl.appendChild(logEntry);
                this.logsEl.scrollTop = this.logsEl.scrollHeight;
            }
            
            clearLogs() {
                this.logsEl.innerHTML = '';
                this.log('üóëÔ∏è –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.wsTest = new WebSocketTest();
        });
    </script>
</body>
</html>